package uk.co.awe.pmat.gui;

import java.awt.event.ActionEvent;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.IOException;
import javax.swing.AbstractAction;
import javax.swing.JFileChooser;
import javax.swing.JPanel;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.filechooser.FileFilter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import uk.co.awe.pmat.ApplicationException;
import uk.co.awe.pmat.Configuration;
import uk.co.awe.pmat.Constants;
import uk.co.awe.pmat.db.Run;
import uk.co.awe.pmat.gui.models.ImportModel;
import uk.co.awe.pmat.gui.utils.DisplayTableModel;
import uk.co.awe.pmat.utils.RegExpFilenameFilter;

/**
 * A panel for the import of PMAT export files.
 * 
 * @author AWE Plc copyright 2013
 */
final class ImportView extends JPanel {

	private static final Logger LOG = LoggerFactory.getLogger(ImportView.class);

	private static final String EXPORT_EXTENSION = Constants.Export.EXTENSION;
	private static final String EXPORT_DESCRIPTION = Constants.Export.DESCRIPTION;

	private final DisplayTableModel tableModel;
	private final ImportModel importModel;
	private final JFileChooser fileChooser;
	private final Configuration config;

	/**
	 * Create a new {@code ImportView}.
	 * 
	 * @param importModel
	 *            the model driving this view.
	 * @param config
	 *            the application configuration.
	 * @param workerListener
	 *            the listener to be informed of any background tasks.
	 */
	ImportView(final ImportModel importModel, final Configuration config) {

		initComponents();

		this.config = config;
		this.importModel = importModel;

		fileChooser = new JFileChooser();
		for (FileFilter f : fileChooser.getChoosableFileFilters()) {
			fileChooser.removeChoosableFileFilter(f);
		}
		fileChooser.setFileFilter(new RegExpFilenameFilter(EXPORT_DESCRIPTION
				+ " (" + EXPORT_EXTENSION + ")", ".*\\" + EXPORT_EXTENSION));

		importFileField.setText(config
				.getProperty(Configuration.Key.IMPORT_FILE_PATH));
		importFileField.getDocument().addDocumentListener(
				new DocumentListener() {
					@Override
					public void insertUpdate(DocumentEvent e) {
						pathTextBoxChanged();
					}

					@Override
					public void removeUpdate(DocumentEvent e) {
						pathTextBoxChanged();
					}

					@Override
					public void changedUpdate(DocumentEvent e) {
						pathTextBoxChanged();
					}
				});
		pathTextBoxChanged();

		tableModel = importModel.getTableModel();
		runsTable.setModel(tableModel);
		setButtonActions();
	}

	/**
	 * Set the actions on the buttons.
	 */
	private void setButtonActions() {
		browseButton.setAction(new AbstractAction("Browse") {
			@Override
			public void actionPerformed(ActionEvent e) {
				int result = fileChooser.showDialog(ImportView.this, "Import");
				if (result == JFileChooser.APPROVE_OPTION) {
					importFileField.setText(fileChooser.getSelectedFile()
							.getAbsolutePath());
				}
			}
		});
		importButton.setAction(importModel.getImportAction());
		loadButton.setAction(importModel.getLoadAction());
		importButton.getAction().setEnabled(false);
		loadButton.getAction().setEnabled(false);
		pathTextBoxChanged();
	}

	/**
	 * Parse the path given in the path text field when it changes.
	 */
	private void pathTextBoxChanged() {
		config.setProperty(Configuration.Key.IMPORT_FILE_PATH, importFileField
				.getText());
		final File importFile = new File(importFileField.getText());
		importModel.setImportFile(importFile);
	}

	/**
	 * This method is called from within the constructor to initialise the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
	// <editor-fold defaultstate="collapsed"
	// desc="Generated Code">//GEN-BEGIN:initComponents
	private void initComponents() {
		java.awt.GridBagConstraints gridBagConstraints;

		setBorder(javax.swing.BorderFactory.createEmptyBorder(0, 5, 0, 5));
		setLayout(new java.awt.BorderLayout());

		runsScroll.setViewportView(runsTable);

		add(runsScroll, java.awt.BorderLayout.CENTER);

		buttonPanel.setLayout(new java.awt.GridBagLayout());

		buttonSpacer.setMaximumSize(new java.awt.Dimension(0, 0));
		buttonSpacer.setMinimumSize(new java.awt.Dimension(0, 0));
		buttonSpacer.setPreferredSize(new java.awt.Dimension(0, 0));

		javax.swing.GroupLayout buttonSpacerLayout = new javax.swing.GroupLayout(
				buttonSpacer);
		buttonSpacer.setLayout(buttonSpacerLayout);
		buttonSpacerLayout.setHorizontalGroup(buttonSpacerLayout
				.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
				.addGap(0, 276, Short.MAX_VALUE));
		buttonSpacerLayout.setVerticalGroup(buttonSpacerLayout
				.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
				.addGap(0, 35, Short.MAX_VALUE));

		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.gridx = 0;
		gridBagConstraints.gridy = 0;
		gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
		gridBagConstraints.weightx = 1.0;
		buttonPanel.add(buttonSpacer, gridBagConstraints);

		importButton.setText("Import");
		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.gridx = 2;
		gridBagConstraints.gridy = 0;
		gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
		buttonPanel.add(importButton, gridBagConstraints);

		loadButton.setText("Load");
		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.gridx = 1;
		gridBagConstraints.gridy = 0;
		gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
		buttonPanel.add(loadButton, gridBagConstraints);

		add(buttonPanel, java.awt.BorderLayout.PAGE_END);

		importFilePanel.setLayout(new java.awt.GridBagLayout());

		importFileLabel.setLabelFor(importFileField);
		importFileLabel.setText("Import File");
		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.insets = new java.awt.Insets(0, 0, 0, 5);
		importFilePanel.add(importFileLabel, gridBagConstraints);

		importFileField.setText("Select File...");
		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
		gridBagConstraints.weightx = 1.0;
		importFilePanel.add(importFileField, gridBagConstraints);

		browseButton.setText("Browse");
		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 0);
		importFilePanel.add(browseButton, gridBagConstraints);

		add(importFilePanel, java.awt.BorderLayout.PAGE_START);
	}// </editor-fold>//GEN-END:initComponents

	// Variables declaration - do not modify//GEN-BEGIN:variables
	private final javax.swing.JButton browseButton = new javax.swing.JButton();
	private final javax.swing.JPanel buttonPanel = new javax.swing.JPanel();
	private final javax.swing.JPanel buttonSpacer = new javax.swing.JPanel();
	private final javax.swing.JButton importButton = new javax.swing.JButton();
	private final javax.swing.JTextField importFileField = new javax.swing.JTextField();
	private final javax.swing.JLabel importFileLabel = new javax.swing.JLabel();
	private final javax.swing.JPanel importFilePanel = new javax.swing.JPanel();
	private final javax.swing.JButton loadButton = new javax.swing.JButton();
	private final javax.swing.JScrollPane runsScroll = new javax.swing.JScrollPane();
	private final javax.swing.JTable runsTable = new uk.co.awe.pmat.gui.utils.DisplayTable();
	// End of variables declaration//GEN-END:variables

}
